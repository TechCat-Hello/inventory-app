{% extends "base.html" %}

{% block title %}ユーザーダッシュボード{% endblock %}

{% block content %}

  <h1>ユーザーダッシュボード</h1>
  <p>ようこそ、{{ request.user.username }}さん（一般ユーザー）</p>
  <p><a href="{% url 'item_list' %}">備品一覧を確認する・借りる</a></p>
  <p><a href="{% url 'item_create' %}">新しい備品を登録する</a></p>

  <h2>あなたの貸出中の備品一覧</h2>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>備品名</th>
        <th>個数</th>
        <th>貸出日</th>
        <th>予定返却日</th>
        <th>返却日</th>
        <th>ステータス</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for rental in rentals %}
        <tr>
          <td>{{ rental.item.name }}</td>
          <td>{{ rental.quantity }}</td>
          <td>{{ rental.rental_date|date:"Y/m/d" }}</td>
          <td>
            {% if rental.expected_return_date %}
              {{ rental.expected_return_date|date:"Y/m/d" }}
            {% else %}
              ―
            {% endif %}
          </td>
          <td>
            {% if rental.return_date %}
              {{ rental.return_date|date:"Y/m/d" }}
            {% else %}
              ―
            {% endif %}
          </td>
          <td>{{ rental.get_status_display }}</td>
          <td>
            {% if rental.status == 'borrowed' and rental.quantity > 0 %}
              <form method="post" action="{% url 'return_item' rental.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-primary">1個返却</button>
              </form>
            {% else %}
              返却済
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="7">貸出中の備品はありません。</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <h2>あなたが登録した備品一覧</h2>
  <ul class="list-group">
    {% for item in items %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ item.name }}（{{ item.quantity }}個）
        <span>
          {% if item.added_by == request.user %}
            <a href="{% url 'edit_item' item.pk %}" class="btn btn-sm btn-outline-secondary">編集</a>
            <a href="{% url 'item_delete' item.pk %}" class="btn btn-sm btn-outline-danger">削除</a>
          {% endif %}
        </span>
      </li>
    {% empty %}
      <li class="list-group-item">登録された備品がありません。</li>
    {% endfor %}
  </ul>

  <h3>貸出履歴ダウンロード</h3>
  <ul>
      <li><a href="{% url 'export_rentals_csv' %}">CSV形式でダウンロード</a></li>
      <li><a href="{% url 'export_rentals_excel' %}">Excel形式でダウンロード</a></li>
      <li><a href="{% url 'export_rentals_pdf' %}">PDF形式でダウンロード</a></li>
  </ul>

  <h2>あなたの貸出台数の月別推移（合計）</h2>
  <canvas id="monthlyRentalChart" width="800" height="400"></canvas>

  <h2>あなたの貸出台数の品目別 月別推移</h2>
  <canvas id="rentalChart" width="800" height="400"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // 月別貸出台数合計グラフ
    const ctxMonthly = document.getElementById('monthlyRentalChart').getContext('2d');
    const monthlyRentalChart = new Chart(ctxMonthly, {
        type: 'bar',
        data: {
            labels: {{ labels|safe }},
            datasets: [{
                label: '貸出台数合計',
                data: {{ data|safe }},
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: '貸出台数' } },
                x: { title: { display: true, text: '年月' } }
            }
        }
    });

    // 品目別 月別貸出台数グラフ
    const ctxItem = document.getElementById('rentalChart').getContext('2d');
    const rentalChart = new Chart(ctxItem, {
        type: 'bar',
        data: {
            labels: {{ labels|safe }},
            datasets: {{ datasets|safe }},
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
            },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: '貸出台数' } },
                x: { title: { display: true, text: '年月' } }
            }
        }
    });
  </script>

{% endblock %}


