{% extends "base.html" %}

{% block title %}ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  <p>ã‚ˆã†ã“ãã€<strong>{{ request.user.username }}</strong> ã•ã‚“ï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</p>

  <div class="mb-4">
    <a href="{% url 'item_list' %}" class="btn btn-primary btn-sm me-2">â–¶ å‚™å“ä¸€è¦§ã‚’ç¢ºèªãƒ»å€Ÿã‚Šã‚‹</a>
    <a href="{% url 'item_create' %}" class="btn btn-success btn-sm">ï¼‹ æ–°ã—ã„å‚™å“ã‚’ç™»éŒ²ã™ã‚‹</a>
  </div>

  <!-- è²¸å‡ºä¸­ã®å‚™å“ä¸€è¦§ -->
  <div class="card mb-5 shadow-sm">
    <div class="card-header bg-info text-white">
      <h2 class="h5 mb-0">è²¸å‡ºä¸­ã®å‚™å“ä¸€è¦§</h2>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>å‚™å“å</th>
              <th>å€‹æ•°</th>
              <th>è²¸å‡ºæ—¥</th>
              <th>äºˆå®šè¿”å´æ—¥</th>
              <th>è¿”å´æ—¥</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {% for rental in rentals %}
              <tr>
                <td>{{ rental.item.name }}</td>
                <td>{{ rental.quantity }}</td>
                <td>{{ rental.rental_date|date:"Y/m/d" }}</td>
                <td>{{ rental.expected_return_date|default:"â€•"|date:"Y/m/d" }}</td>
                <td>{{ rental.return_date|default:"â€•"|date:"Y/m/d" }}</td>
                <td>{{ rental.get_status_display }}</td>
                <td>
                  {% if rental.status == 'borrowed' and rental.quantity > 0 %}
                    <form method="post" action="{% url 'return_item' rental.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-primary nowrap-btn">1å€‹è¿”å´</button>
                    </form>
                  {% else %}
                    <span class="text-muted">è¿”å´æ¸ˆ</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="7" class="text-center">è²¸å‡ºä¸­ã®å‚™å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ç™»éŒ²å‚™å“ä¸€è¦§ -->
  <div class="card mb-5 shadow-sm">
    <div class="card-header bg-secondary text-white">
      <h2 class="h5 mb-0">è‡ªåˆ†ãŒç™»éŒ²ã—ãŸå‚™å“ä¸€è¦§</h2>
    </div>
    <div class="card-body">
      <ul class="list-group">
        {% for item in items %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ item.name }}ï¼ˆ{{ item.quantity }}å€‹ï¼‰</span>
            <span>
              <a href="{% url 'edit_item' item.pk %}" class="btn btn-sm btn-outline-secondary me-2">ç·¨é›†</a>
              <a href="{% url 'item_delete' item.pk %}" class="btn btn-sm btn-outline-danger">å‰Šé™¤</a>
            </span>
          </li>
        {% empty %}
          <li class="list-group-item text-center">ç™»éŒ²ã•ã‚ŒãŸå‚™å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
  <div class="card mb-5 shadow-sm">
    <div class="card-header bg-light">
      <h2 class="h5 mb-0">è²¸å‡ºå±¥æ­´ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
    </div>
    <div class="card-body">
      <ul class="list-unstyled">
        <li><a href="{% url 'export_rentals_csv' %}">CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a></li>
        <li><a href="{% url 'export_rentals_excel' %}">Excelå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a></li>
        <li><a href="{% url 'export_rentals_pdf' %}">PDFå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a></li>
      </ul>
    </div>
  </div>

  <!-- ã‚°ãƒ©ãƒ• -->
  <div>
    <div style="margin-top: 2rem; padding: 1rem; border: 1px solid #ccc; border-radius: 8px;">
      <h2 style="font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; text-align: center;">ğŸ“Š æœˆåˆ¥è²¸å‡ºå°æ•°åˆè¨ˆ</h2>
      <canvas id="monthlyRentalChart" height="300"></canvas>
    </div>
    <div style="margin-top: 2rem; padding: 1rem; border: 1px solid #ccc; border-radius: 8px;">
      <h2 style="font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; text-align: center;">ğŸ“¦ å“ç›®åˆ¥ æœˆåˆ¥è²¸å‡ºå°æ•°</h2>
      <canvas id="rentalChart" height="300"></canvas>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctxMonthly = document.getElementById('monthlyRentalChart').getContext('2d');
    new Chart(ctxMonthly, {
      type: 'bar',
      data: {
        labels: {{ labels|safe }},
        datasets: [{
          label: 'è²¸å‡ºå°æ•°åˆè¨ˆ',
          data: {{ data|safe }},
          backgroundColor: 'rgba(75, 192, 192, 0.7)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'è²¸å‡ºå°æ•°' },
            ticks: {
              callback: function(value) {
                if (Number.isInteger(value)) return value;
              },
              stepSize: 1
            }
          },
          x: { title: { display: true, text: 'å¹´æœˆ' } }
        }
      }
    });

    const ctxItem = document.getElementById('rentalChart').getContext('2d');
    new Chart(ctxItem, {
      type: 'bar',
      data: {
        labels: {{ labels|safe }},
        datasets: {{ datasets|safe }},
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'è²¸å‡ºå°æ•°' },
            ticks: {
              callback: function(value) {
                if (Number.isInteger(value)) return value;
              },
              stepSize: 1
            }
          },
          x: { title: { display: true, text: 'å¹´æœˆ' } }
        }
      }
    });
  </script>
</div>
{% endblock %}
